# Аутентификация Supabase - Руководство по настройке

## Обзор

Приложение Transcribe.cafe теперь требует аутентификацию пользователей для доступа ко всем функциям. Используется Supabase в качестве провайдера аутентификации.

## Настройка

### 1. Создание проекта Supabase

1. Перейдите на [supabase.com](https://supabase.com)
2. Создайте новый аккаунт или войдите в существующий
3. Создайте новый проект
4. Дождитесь завершения настройки проекта

### 2. Получение ключей API

1. В панели управления Supabase перейдите в **Settings** → **API**
2. Скопируйте следующие значения:
   - **Project URL** (URL проекта)
   - **anon/public key** (публичный ключ)

### 3. Настройка переменных окружения

1. Скопируйте файл `.env.example` в `.env`:
   ```bash
   cp .env.example .env
   ```

2. Отредактируйте `.env` файл и замените значения:
   ```env
   VITE_API_URL=http://localhost:8001/api
   
   # Supabase Configuration
   VITE_SUPABASE_URL=your_actual_supabase_project_url
   VITE_SUPABASE_ANON_KEY=your_actual_supabase_anon_key
   ```

### 4. Настройка аутентификации в Supabase

1. В панели управления Supabase перейдите в **Authentication** → **Settings**
2. Настройте следующие параметры:
   - **Site URL**: `http://localhost:5173` (для разработки)
   - **Redirect URLs**: добавьте `http://localhost:5173/auth/callback`

### 5. Настройка email шаблонов (опционально)

1. Перейдите в **Authentication** → **Email Templates**
2. Настройте шаблоны для:
   - Подтверждение регистрации
   - Сброс пароля
   - Изменение email

## Использование

### Регистрация нового пользователя

1. Откройте приложение в браузере
2. Нажмите "Нет аккаунта? Зарегистрироваться"
3. Введите email и пароль
4. Подтвердите пароль
5. Нажмите "Зарегистрироваться"
6. Проверьте email для подтверждения регистрации

### Вход в систему

1. Введите email и пароль
2. Нажмите "Войти"

### Сброс пароля

1. На странице входа нажмите "Забыли пароль?"
2. Введите ваш email
3. Нажмите "Отправить инструкции"
4. Проверьте email и следуйте инструкциям

### Выход из системы

1. Нажмите на ваш email в правом верхнем углу
2. Выберите "Выйти"

## Разработка

### Запуск тестов

```bash
# Запуск всех тестов
npm test

# Запуск тестов один раз
npm run test:run

# Запуск тестов с UI
npm run test:ui
```

### Структура компонентов аутентификации

```
src/
├── contexts/
│   └── AuthContext.jsx          # Контекст аутентификации
├── components/
│   ├── AuthForm.jsx            # Форма входа/регистрации
│   ├── ProtectedRoute.jsx      # Защищенный маршрут
│   └── Header.jsx              # Заголовок с информацией о пользователе
├── pages/
│   └── AuthPage.jsx            # Страница аутентификации
├── lib/
│   └── supabase.js             # Конфигурация Supabase
├── services/
│   └── api.js                  # API сервис с аутентификацией
└── utils/
    └── errorHandling.js        # Утилиты обработки ошибок
```

## Безопасность

### Row Level Security (RLS)

Рекомендуется настроить RLS политики в Supabase для защиты данных пользователей:

```sql
-- Включить RLS для таблицы videos
ALTER TABLE videos ENABLE ROW LEVEL SECURITY;

-- Политика: пользователи видят только свои видео
CREATE POLICY "Users can view own videos" ON videos
    FOR SELECT USING (auth.uid() = user_id);

-- Политика: пользователи могут создавать только свои видео
CREATE POLICY "Users can insert own videos" ON videos
    FOR INSERT WITH CHECK (auth.uid() = user_id);

-- Политика: пользователи могут обновлять только свои видео
CREATE POLICY "Users can update own videos" ON videos
    FOR UPDATE USING (auth.uid() = user_id);
```

### Переменные окружения

- Никогда не коммитьте `.env` файл в репозиторий
- Используйте разные ключи для разработки и продакшена
- Регулярно ротируйте API ключи

## Устранение неполадок

### Ошибка "Invalid login credentials"

- Проверьте правильность email и пароля
- Убедитесь, что email подтвержден

### Ошибка "Email not confirmed"

- Проверьте папку спам в email
- Повторно отправьте письмо подтверждения

### Ошибка подключения к Supabase

- Проверьте правильность URL и ключей в `.env`
- Убедитесь, что проект Supabase активен

### Проблемы с CORS

- Добавьте ваш домен в разрешенные origins в настройках Supabase
- Для разработки добавьте `http://localhost:5173`

## Дополнительные возможности

### Социальная аутентификация

Supabase поддерживает аутентификацию через:
- Google
- GitHub
- Facebook
- Twitter
- И другие провайдеры

### Multi-Factor Authentication (MFA)

Можно включить двухфакторную аутентификацию для дополнительной безопасности.

### Кастомные email шаблоны

Настройте собственные шаблоны email для лучшего пользовательского опыта.

## Поддержка

Если у вас возникли проблемы:

1. Проверьте логи в консоли браузера
2. Проверьте логи в панели управления Supabase
3. Убедитесь, что все переменные окружения настроены правильно
4. Проверьте статус сервисов Supabase на [status.supabase.com](https://status.supabase.com)